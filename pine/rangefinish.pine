//@version=6
indicator("Range breaking indicator", overlay=false, max_labels_count=1)

// ----------------------
// Configuración
// ----------------------
len = input.int(50, "Número de velas a analizar", minval=1)
use_volume = input.bool(false, "Usar volumen para ponderar área")
balance_threshold = input.float(10.0, "Umbral de equilibrio (%)", minval=0.0, maxval=50.0)

// ----------------------
// Cálculo de área por vela
// ----------------------
area = use_volume ? math.abs(close - open) * volume : math.abs(close - open)
bull_area = close > open ? area : 0.0
bear_area = close < open ? area : 0.0

// ----------------------
// Ventana rodante: buffers + suma incremental
// ----------------------
var float[] bull_buf = array.new<float>()
var float[] bear_buf = array.new<float>()
var float bull_running = 0.0
var float bear_running = 0.0

// Actualizar buffer y suma para bullish
array.push(bull_buf, bull_area)
bull_running += bull_area
if array.size(bull_buf) > len
    old_bull = array.shift(bull_buf)
    bull_running -= old_bull

// Actualizar buffer y suma para bearish
array.push(bear_buf, bear_area)
bear_running += bear_area
if array.size(bear_buf) > len
    old_bear = array.shift(bear_buf)
    bear_running -= old_bear

// ----------------------
// Cálculo de porcentajes
// ----------------------
total_area = bull_running + bear_running
bull_pct = total_area > 0 ? (bull_running / total_area) * 100.0 : na
bear_pct = total_area > 0 ? (bear_running / total_area) * 100.0 : na

// ----------------------
// Visualización
// ----------------------
plot(bull_pct, title="Bullish %", color=color.new(color.lime, 0), linewidth=2)
plot(bear_pct, title="Bearish %", color=color.new(color.red, 0), linewidth=2)
hline(50, "Equilibrio 50%", color=color.gray, linestyle=hline.style_dotted)

// ----------------------
// Señal y alerta de equilibrio (posible fin de rango)
// ----------------------
is_balanced = not na(bull_pct) and math.abs(bull_pct - 50.0) <= balance_threshold
plotshape(is_balanced, title="Posible fin de rango", location=location.bottom, color=color.yellow, style=shape.triangleup, size=size.tiny)

// ⚠️ Alerta (mensaje constante requerido por Pine)
const string alert_msg = "El rango de las últimas velas está equilibrado (posible final de rango)."
alertcondition(is_balanced, title="Alerta: equilibrio detectado", message=alert_msg)
